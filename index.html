<!DOCTYPE html>

<head>
    <script src="target/teavm/classes.js"></script>
    <script src="target/teavm/classes.wasm-runtime.js"></script>
</head>

<style>
    body {
        font-family: sans-serif;
        line-height: 1.6;
        max-width: 800px;
        margin: 40px auto;
        padding: 0 20px;
    }

    .formula {
        background: #f4f4f4;
        padding: 15px;
        border-left: 5px solid #333;
        margin: 20px 0;
        text-align: center;
    }

    .line {
        margin-top: 4px;
        display: flex;
    }

    .line-header {
        width: 200px;
    }

    .highlight {
        font-weight: bold;
        color: #2c3e50;
    }

    table {
        border-collapse: collapse;
        width: 100%;
        text-align: center;
    }

    .highlight-row-bottom td {
        border-bottom: 2px solid rgb(104, 104, 104);
    }

    .highlight-row-bottom th {
        border-bottom: 2px solid rgb(104, 104, 104);
    }

    .highlight-row-top th {
        border-top: 2px solid rgb(104, 104, 104);
    }

    .x {
        border-bottom: 2px solid rgb(104, 104, 104);
    }

    .right-border {
        border-right: 2px solid rgb(104, 104, 104);
    }

    .col {
        width: 150px;
    }
</style>

<body>
    <script>
        let teavmInstance = null;
        const WASM_PATH = 'target/teavm/classes.wasm';

        // 1. Hauptfunktion zum Laden des WASM-Moduls
        async function loadWasm() {
            try {

                teavmInstance = await TeaVM.wasm.load(WASM_PATH);

                if (teavmInstance.instance.exports.initializeApp) {
                    teavmInstance.instance.exports.initializeApp();
                } else {
                    console.error("initializeApp wurde nicht exportiert!");
                }
            } catch (error) {
                console.error("Fehler beim Laden des WASM-Moduls:", error);
                document.getElementById('output').textContent = "Laden fehlgeschlagen: " + error.message;
            }
        }

        // 3. Funktion zum Aufruf der Additionsmethode
        function start_wasm() {
            if (!teavmInstance) {
                alert("Error")
                return;
            }

            const steps = parseInt(document.getElementById('daysInput').value);
            const sims = parseInt(document.getElementById('simulations').value);
            const sum = teavmInstance.instance.exports.doDynamicOptimisationWasm(steps, sims);

            console.log(sum)
        }

        // Starten Sie den Ladevorgang, sobald das DOM bereit ist
        document.addEventListener('DOMContentLoaded', loadWasm);
    </script>


    <script>
        function start() {
            try {
                document.getElementById("output").textContent = "Running ..."
                main();
                const steps = parseInt(document.getElementById('daysInput').value);
                const sims = parseInt(document.getElementById('simulations').value);

                const sum = doDynamicOptimisation(steps, sims);
                const resultText = "Job done in " + sum / 1000 + " seconds";
                document.getElementById("output").textContent = resultText;
            } catch {
                document.getElementById("output").textContent = "An error occurred";
            }
        }       
    </script>

    <h1>Analysis of runtime</h2>
        <p>
            To check the runtime of a java program which was transpiled to wasm and js using teavm i created a small
            montecarlo simulation + dynamic optimization problem.
            Input parameter: simulations and time steps
            The states are fixed to 3 states.
            The different states are defined as:
        <div class="formula">
            <div> I - (P1-P2)*0.904 - 45</div>
            <div>II - (P1-P2)*0.75 - 37</div>
            <div>III - (P1-P2)*0.6 - 30</div>
        </div>
        P1 and P2 are simulated values:
        <div class="formula">
            <p>
                <i>P</i>(<i>x</i>) =
                (1 / &sigma;&radic;2&pi;)
                <i>e</i><sup>-&frac12;((<i>x</i>-&mu;)/&sigma;)<sup>2</sup></sup>
            <div>with:
                <div>
                    &sigma; = [4,2]
                </div>
                <div>
                    &mu; = [100,50]
                </div>
            </div>
            </p>
        </div>
        </p>

        <h3>Parameter</h3>
        <div class="line">
            <div class="line-header">timesteps:</div>
            <input type="number" id="daysInput" value="365">
        </div>
        <div class="line">
            <div class="line-header">Simulations:</div>
            <input type="number" id="simulations" value="1000">
        </div>

        <button onclick="start()">Do Simulation+Optimization with js</button>
        <button onclick="start_wasm()">Do Simulation+Optimization with wasm</button>


        <div style="margin-top: 20px;">
            <strong>Result:</strong> <span id="output">No calculation yet</span>
        </div>

        <h3>Previour results</h3>
        <div>Some experiments have on my local machine has given me following results</div>
        <table>
            <tr class="highlight-row-top">
                <th class="x" rowspan="2">Runtime in sec</th>
                <th colspan="6">Simulations (with 365 time steps)</th>
            </tr>
            <tr class="highlight-row-bottom">
                <td class="col">2500</td>
                <td class="col">5000</td>
                <td class="col">10_000</td>
                <td class="col">25_000</td>
                <td class="col">50_000</td>
                <td class="col">100_000</td>
            </tr>
            <tr>
                <th class="right-border">java</th>
                <td>0.255</td>
                <td>0.450</td>
                <td>0.925</td>
                <td>2.262</td>
                <td>4.200</td>
                <td>out of memory</td>
            </tr>
            <tr>
                <th class="right-border">js</th>
                <td>0.738</td>
                <td>1.838</td>
                <td>3.689</td>
                <td>9.798</td>
                <td>out of memory</td>
                <td>out of memory</td>
            </tr>
            <tr>
                <th class="right-border">wasm</th>
                <td>to do</td>
                <td>to do</td>
                <td>to do</td>
                <td>to do</td>
                <td>to do</td>
                <td>to do</td>
            </tr>

        </table>
</body>

</html>